---
title: 'DeFi yield optimizer'
description: 'Optimize your DeFi yields automatically'
---

The DeFi Yield Optimizer template helps you automatically optimize your DeFi portfolio by moving funds to the highest yielding protocols. This guide walks you through using the template to create a workflow that monitors yield rates and executes rebalancing transactions to maximize returns.

## Prerequisites

Before you begin, ensure you have:

- A Web3 wallet such as MetaMask connected on your Kwala dashboard
- Kwala credits in your account
- A good understanding of DeFi protocols and yield farming
- Token approvals for protocols you want to interact with
- An understanding of risk management and awareness of smart contract risks
- Sufficient funds for gas fees and minimum deposit amounts

## Use cases

This template is ideal for the following scenarios:

- Automatically moving funds between lending protocols for optimal Annual Percentage Yield (APY)
- Rebalancing liquidity pool positions based on yield changes
- Monitoring multiple DeFi protocols and executing strategic shifts
- Factoring in gas costs to ensure yield improvements outweigh transaction fees
- Logging rebalancing activities for portfolio tracking and tax purposes
- Setting minimum yield thresholds before triggering rebalancing

## Step 1: Access the template

1. Navigate to the [Kwala dashboard](https://app.kwala.network/dashboard) and select **My workflows**
2. Select **Templates** from the navigation menu
3. Find and select **DeFi Yield Optimizer**
4. Select **View Details** to open the template

<Frame>
  <img src="/images/use-cases/defi-yield-optimizer/template-overview.PNG" alt="DeFi yield optimizer template overview" />
</Frame>

## Step 2: Provide a workflow name

In the template overview, select **Deploy Template** or **Edit Template** to open it in the Workflow Editor.

On the YAML editor, give your workflow a descriptive name: 

```yaml
Name: defi_yield_optimizer
```

When you update the name in the YAML editor, it also reflects in the workflow information pane.

## Step 3: Configure triggers

The template is pre-configured with event-based triggers that you can customize. For DeFi yield optimization, you may want to use time-based or event-based triggers depending on your strategy.

**Execute after**

Set to `event` to trigger when a specific event occurs (such as a deposit or withdrawal):

```yaml
Trigger:
  ExecuteAfter: event
```

For time-based periodic checks, you can use interval-based execution:

```yaml
Trigger:
  ExecuteAfter: 1735689600  # Unix timestamp for immediate start
  RepeatEvery: "86400"  # Repeat every 24 hours (daily)
```

<Note>
  Time-based triggers are ideal for periodic APY monitoring. Common intervals: `"3600"` (hourly), `"86400"` (daily), `"604800"` (weekly). The template uses event-based triggers as an example, but time-based triggers are recommended for yield optimization strategies.
</Note>

**Repeat after**

Set to `event` to repeat every time the event occurs, or use a time interval:

```yaml
  RepeatEvery: event
```

**Contract monitoring**

Update the contract address and chain ID to match the protocol you want to monitor:

```yaml
  TriggerChainID: 1  # 1 for Ethereum mainnet
  TriggerSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  TriggerEventName: Transfer(address,address,uint256)
```

**ABI configuration**

The template includes a base64-encoded ABI. You can replace this by:

1. Uploading your protocol's contract `.sol` file in the Workflow Builder
2. Pasting the contract ABI directly

```yaml
  TriggerSourceContractABI: W3siaW5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAi...
```

**Expiry date**

Set when the workflow should stop monitoring:

```yaml
  ExpiresIn: 1781796603  # Unix timestamp
```

## Step 4: Configure recurring triggers

For repeated execution, configure the recurring source to monitor continuously:

```yaml
  RecurringChainID: 1
  RecurringSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  RecurringEventName: Transfer(address,address,uint256)
  RecurringEventFilter: NA
  RecurringSourceContractABI: W3siaW5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAi...
```

## Step 5: Configure rebalancing actions

The template includes two actions: a smart contract call to transfer funds and a notification action.

**Action 1: Transfer funds**

This action calls a smart contract function to move funds between protocols:

```yaml
Actions:
  - Name: transfer_funds
    Type: call
    TargetContract: 0x0f51bb10119727a7e5ea3538074fb341f56b09ad
    TargetFunction: function transfer(address recipient,uint256 amount)
    TargetParams:
      - 0x49e833337ece7afe375e44f4e3e8481029218e5c
      - 100
    ChainID: 1
    RetriesUntilSuccess: 5
```

**Customization options for fund transfers:**

- `TargetContract`: The protocol's contract address (e.g., lending pool, vault)
- `TargetFunction`: The function to call (e.g., `withdraw`, `deposit`, `transfer`)
- `TargetParams`: Parameters for the function (recipient address, amount)
- `ChainID`: The blockchain network (1 for Ethereum, 137 for Polygon, etc.)
- `RetriesUntilSuccess`: Number of retry attempts if the transaction fails

**Example: Withdraw from Protocol A**

```yaml
  - Name: withdraw_from_protocol_a
    Type: call
    TargetContract: 0xProtocolA_Address
    TargetFunction: function withdraw(uint256 amount)
    TargetParams:
      - 1000000000000000000  # 1 token (18 decimals)
    ChainID: 1
    RetriesUntilSuccess: 3
```

**Example: Deposit to Protocol B**

```yaml
  - Name: deposit_to_protocol_b
    Type: call
    TargetContract: 0xProtocolB_Address
    TargetFunction: function deposit(uint256 amount)
    TargetParams:
      - 1000000000000000000  # 1 token (18 decimals)
    ChainID: 1
    RetriesUntilSuccess: 3
```

**Action 2: Notification**

This action sends a notification after rebalancing:

```yaml
  - Name: notification_action
    Type: post
    APIEndpoint: https://workflow-notification-test.kalp.network/push_notification
    APIPayload:
      success: true
    RetriesUntilSuccess: 5
```

**Enhanced notification with details:**

```yaml
  - Name: notification_action
    Type: post
    APIEndpoint: https://discord.com/api/webhooks/your-webhook-id
    APIPayload:
      content: "ðŸ’° DeFi Yield Optimization Complete!"
      embeds:
        - title: "Rebalancing Alert"
          description: "Funds successfully moved to higher yield protocol"
          fields:
            - name: "From Protocol"
              value: "Protocol A (APY: 3.2%)"
            - name: "To Protocol"
              value: "Protocol B (APY: 5.8%)"
            - name: "Amount"
              value: "1000 USDC"
            - name: "Expected Gain"
              value: "+2.6% APY"
          color: 3447003
    RetriesUntilSuccess: 5
```

## Step 6: Set execution mode

The template uses **sequential execution**, which is critical for DeFi operations where order matters:

```yaml
Execution:
  Mode: sequential
```

<Warning>
  **Sequential execution is essential for DeFi yield optimization.** Funds must be withdrawn from one protocol before they can be deposited into another. Using parallel execution could cause transactions to fail.
</Warning>

You should keep this as `sequential` to ensure:
- Withdrawal completes before deposit
- Proper error handling at each step
- Accurate tracking of fund movements

## Step 7: Add notification settings (optional)

Configure status notifications to receive updates about workflow execution:

```yaml
Trigger:
  ActionStatusNotificationPOSTURL: https://workflow-notification-test.kalp.network/push_notification
  ActionStatusNotificationAPIKey: NA
```

### Add more actions

You can extend the template to include additional actions for more complex yield strategies:

**Example: Check APY before rebalancing**

```yaml
- Name: fetch_apy_data
  Type: post
  APIEndpoint: https://api.defi-protocol.com/v1/apy
  APIPayload:
    protocols: ["aave", "compound", "yearn"]
  RetriesUntilSuccess: 2
```

**Example: Log rebalancing to database**

```yaml
- Name: log_rebalancing
  Type: post
  APIEndpoint: https://your-api.com/log-transaction
  APIPayload:
    action: "yield_optimization"
    fromProtocol: "Protocol A"
    toProtocol: "Protocol B"
    amount: "1000"
    timestamp: "{{timestamp}}"
    gasUsed: "{{gasUsed}}"
  RetriesUntilSuccess: 2
```

**Example: Multi-protocol optimization**

```yaml
- Name: withdraw_from_aave
  Type: call
  TargetContract: 0xAave_LendingPool_Address
  TargetFunction: function withdraw(address asset, uint256 amount, address to)
  TargetParams:
    - 0xUSDC_Address
    - 1000000000  # 1000 USDC (6 decimals)
    - 0xYour_Wallet_Address
  ChainID: 1
  RetriesUntilSuccess: 3

- Name: deposit_to_compound
  Type: call
  TargetContract: 0xCompound_cUSDC_Address
  TargetFunction: function mint(uint256 mintAmount)
  TargetParams:
    - 1000000000  # 1000 USDC (6 decimals)
  ChainID: 1
  RetriesUntilSuccess: 3
```

## Step 8: Compile and validate

Before deploying:

1. Select **Compile** to validate your configuration
2. Check the **Console Logs** for any errors
3. Review the **Validation** pane for real-time feedback
4. Verify all contract addresses and function signatures are correct

<Tip>
  **Gas optimization tip:** Test your workflow with small amounts first to ensure it works correctly before deploying with larger sums. This helps you understand gas costs and verify the logic.
</Tip>

## Step 9: Deploy and activate

Once your workflow is configured:

1. Select **Save Workflow**
2. Approve the transaction in your wallet
3. Select **Deploy** to submit to the Kwala network
4. Select **Activate** to start monitoring and executing yield optimization

## Complete workflow example

Here's the complete YAML for reference:

```yaml
Name: defi_yield_optimizer
Trigger:
  TriggerSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  TriggerChainID: 1
  TriggerEventName: Transfer(address,address,uint256)
  TriggerEventFilter: NA
  TriggerSourceContractABI: W3siaW5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAi...
  TriggerPrice: NA
  RecurringSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  RecurringChainID: 1
  RecurringEventName: Transfer(address,address,uint256)
  RecurringEventFilter: NA
  RecurringSourceContractABI: W3siaW5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAi...
  RecurringPrice: NA
  RepeatEvery: event
  ExecuteAfter: event
  ExpiresIn: 1781796603
  Meta: NA
  ActionStatusNotificationPOSTURL: https://workflow-notification-test.kalp.network/push_notification
  ActionStatusNotificationAPIKey: NA
Actions:
  - Name: transfer_funds
    Type: call
    APIEndpoint: NA
    APIPayload:
      Message: NA
    TargetContract: 0x0f51bb10119727a7e5ea3538074fb341f56b09ad
    TargetFunction: function transfer(address recipient,uint256 amount)
    TargetParams:
      - 0x49e833337ece7afe375e44f4e3e8481029218e5c
      - 100
    ChainID: 1
    EncodedABI: NA
    Bytecode: NA
    Metadata: NA
    RetriesUntilSuccess: 5
  - Name: notification_action
    Type: post
    APIEndpoint: https://workflow-notification-test.kalp.network/push_notification
    APIPayload:
      success: true
    TargetContract: NA
    TargetFunction: NA
    TargetParams:
      NA
    ChainID: NA
    EncodedABI: NA
    Bytecode: NA
    Metadata: NA
    RetriesUntilSuccess: 5
Execution:
  Mode: sequential
```

## How it works

The workflow uses an **event-based or time-based trigger** to monitor DeFi protocols for yield optimization opportunities. When triggered, it executes a series of **sequential actions** to move funds from lower-yielding protocols to higher-yielding ones. The sequential execution mode ensures that withdrawal transactions complete before deposit transactions begin, preventing failures and ensuring proper fund movement. After rebalancing, notification actions alert you of the successful optimization.

## Important considerations for DeFi yield optimization

<AccordionGroup>
  <Accordion title="Token approvals">
    Ensure you have approved the protocols to spend your tokens before deploying your workflow. Most DeFi protocols require explicit approval transactions before they can interact with your funds.
  </Accordion>

  <Accordion title="Gas cost considerations">
    Always factor in gas costs when optimizing yields. A rebalancing action only makes sense if the yield improvement outweighs transaction fees. For smaller portfolios, consider longer time intervals between checks to minimize gas spending.
  </Accordion>

  <Accordion title="Protocol risk assessment">
    Only interact with audited and reputable DeFi protocols. Research protocol TVL, audit reports, and historical security before deploying funds. Monitor for smart contract vulnerabilities and diversify across multiple protocols to reduce risk.
  </Accordion>

  <Accordion title="Slippage and minimum deposits">
    Set appropriate slippage tolerances for swaps to prevent failed transactions during high volatility. Also consider minimum deposit requirements for each protocol, as some platforms require threshold amounts for participation.
  </Accordion>

  <Accordion title="Minimum APY thresholds">
    Set minimum APY differences (e.g., 0.5% or 1%) before triggering rebalancing. This prevents frequent rebalancing for marginal gains and reduces unnecessary gas costs.
  </Accordion>

  <Accordion title="Testing and monitoring">
    Always test with small amounts first. Monitor your workflow executions regularly through the Kwala dashboard and set up comprehensive logging to track all rebalancing activities.
  </Accordion>
</AccordionGroup>

## Next steps

<CardGroup cols={2}>
  <Card title="Monitor workflow" icon="chart-line" href="/workflow-builder/monitor-workflow">
    Track your workflow execution status
  </Card>
  <Card title="Best practices" icon="lightbulb" href="/concepts/best-practices">
    Optimize your workflow configuration
  </Card>
  <Card title="Working with actions" icon="wand-magic-sparkles" href="/concepts/work-with-actions">
    Learn more about smart contract calls
  </Card>
  <Card title="Liquidation protection" icon="shield" href="/use-cases/liquidation-protection">
    Protect your DeFi positions
  </Card>
</CardGroup>
