---
title: 'Liquidation protection'
description: 'Protect your positions from liquidation'
---

The Liquidation Protection template helps you automatically protect your DeFi positions by monitoring collateral ratios and adding collateral to prevent liquidation. This guide walks you through using the template to create a workflow that monitors transfer events and executes protective transactions when needed.

## Prerequisites

Before you begin, ensure you have:

- A Web3 wallet such as MetaMask connected on your Kwala dashboard
- Kwala credits in your account
- Active DeFi positions with collateralization requirements
- Emergency fund allocation for automatic top-ups
- A good understanding of DeFi risk management and smart contract risks

## Use cases

This template is ideal for the following scenarios:

- Automatically preventing liquidation on lending protocols
- Maintaining healthy collateral ratios across multiple DeFi positions
- Reducing the burden of manually monitoring leveraged positions
- Executing protective transfers before liquidation events
- Monitoring positions across different protocols and chains
- Creating an automated safety net for high-value positions

## Step 1: Access the template

1. Navigate to the [Kwala dashboard](https://app.kwala.network/dashboard) and select **My workflows**
2. Select **Templates** from the navigation menu
3. Find and select **Liquidation Protection**
4. Select **View Details** to open the template

<Frame>
  <img src="/images/use-cases/liquidation-protection/template-overview.PNG" alt="Liquidation protection template overview" />
</Frame>

## Step 2: Provide a workflow name

In the template overview, select **Deploy Template** or **Edit Template** to open it in the Workflow Editor.

On the YAML editor, give your workflow a descriptive name: 

```yaml
Name: liquidation_protection
```

When you update the name in the YAML editor, it also reflects in the workflow information pane.

## Step 3: Configure triggers

The template is pre-configured with event-based triggers that you can customize:

**Execute after**

Set to `event` to trigger when a transfer event occurs:

```yaml
Trigger:
  ExecuteAfter: event
```

**Repeat after**

Set to `event` to repeat every time the event occurs:

```yaml
  RepeatEvery: event
```

**Contract monitoring**

Update the contract address and chain ID to match the token contract you want to monitor:

```yaml
  TriggerChainID: 1  # 1 for Ethereum mainnet
  TriggerSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  TriggerEventName: Transfer(address,address,uint256)
```

<Note>
  This monitors Transfer events on Ethereum mainnet. For liquidation protection, you'll typically want to monitor the collateral token contract or lending protocol events. Update the contract address and event name to match your specific use case.
</Note>

**ABI configuration**

The template includes a base64-encoded ABI. You can replace this by:

1. Uploading your token contract `.sol` file in the Workflow Builder
2. Pasting the contract ABI directly

```yaml
  TriggerSourceContractABI: W3siaw5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAiLCJuYW1lIjoiX3lmdiIsInR5cGUiOiJhZGRyZXNzIn0seyJpbnRlcm5...
```

**Expiry date**

Set when the workflow should stop monitoring:

```yaml
  ExpiresIn: 1781796603  # Unix timestamp
```

## Step 4: Configure recurring triggers

For repeated execution, configure the recurring source to monitor continuously:

```yaml
  RecurringChainID: 1
  RecurringSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  RecurringEventName: Transfer(address,address,uint256)
  RecurringEventFilter: NA
  RecurringSourceContractABI: W3siaw5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAiLCJuYW1lIjoiX3lmdiIsInR5cGUiOiJhZGRyZXNzIn0seyJpbnRlcm5...
```

## Step 5: Configure protection actions

The template includes two actions: transferring funds and sending notifications.

**Transfer funds**

This action executes an on-chain transfer to add collateral:

```yaml
Actions:
  - Name: transfer_funds
    Type: call
    APIEndpoint: NA
    APIPayload:
      Message: NA
    TargetContract: 0x0f51bb10119727a7e5ea3538074fb341f56b09ad
    TargetFunction: function transfer(address recipient,uint256 amount)
    TargetParams:
      - 0x49e833337ece7afe375e44f4e3e8481029218e5c
      - 100
    ChainID: 1
    EncodedABI: NA
    Bytecode: NA
    Metadata: NA
    RetriesUntilSuccess: 5
```

**Customization options:**

- **TargetContract**: Address of the token contract you're transferring (e.g., USDC, DAI, WETH)
- **TargetParams[0]**: Recipient address (typically your lending protocol position or wallet)
- **TargetParams[1]**: Amount to transfer (in token's smallest unit - wei for ETH, etc.)
- **ChainID**: Blockchain where the transfer occurs (1 for Ethereum mainnet)
- **RetriesUntilSuccess**: Number of retry attempts if transaction fails

**Example: Transfer 1000 USDC**

```yaml
TargetContract: 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
TargetFunction: function transfer(address recipient,uint256 amount)
TargetParams:
  - 0xYourAavePosition_Address
  - 1000000000
```

<Note>USDC uses 6 decimals, so 1000 USDC = 1000000000 (1000 Ã— 10^6).</Note>

**Example: Transfer 0.5 ETH worth of WETH**

```yaml
TargetContract: 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2
TargetFunction: function transfer(address recipient,uint256 amount)
TargetParams:
  - 0xYourCompoundPosition_Address
  - 500000000000000000
```

**Notification action**

This action sends a notification when collateral is added:

```yaml
  - Name: notification_action
    Type: post
    APIEndpoint: https://workflow-notification-test.kalp.network/push_notification
    APIPayload:
      recharged: true
    TargetContract: NA
    TargetFunction: NA
    TargetParams: NA
    ChainID: NA
    EncodedABI: NA
    Bytecode: NA
    Metadata: NA
    RetriesUntilSuccess: 5
```

You can enhance the notification with more details:

```yaml
  - Name: notification_action
    Type: post
    APIEndpoint: https://discord.com/api/webhooks/your-webhook-id
    APIPayload:
      content: "Liquidation Protection Activated!"
      embeds:
        - title: "Collateral Added"
          description: "Automatic collateral top-up executed"
          fields:
            - name: "Amount"
              value: "100 tokens"
            - name: "Position"
              value: "Aave ETH Position"
            - name: "Status"
              value: "Protected"
          color: 3066993
    RetriesUntilSuccess: 5
```

## Step 6: Set execution mode

The template uses sequential execution, ensuring actions run one after another:

```yaml
Execution:
  Mode: sequential
```

<Warning>
  For liquidation protection, sequential execution is critical. The notification should only be sent after confirming the collateral transfer succeeded. This prevents false alerts and ensures accurate logging.
</Warning>

## Step 7: Add notification settings (optional)

The workflow includes a status notification endpoint for tracking execution:

```yaml
ActionStatusNotificationPOSTURL: https://workflow-notification-test.kalp.network/push_notification
ActionStatusNotificationAPIKey: NA
```

**Add more actions**

You can extend the workflow with additional protective measures:

**Example: Log to monitoring service**

```yaml
- Name: log_protection_event
  Type: post
  APIEndpoint: https://your-monitoring-service.com/api/log
  APIPayload:
    event: "liquidation_protection_triggered"
    workflow: "{{workflow.name}}"
    chain: "ethereum"
    amount_transferred: "100"
```

**Example: Alert to multiple channels**

```yaml
- Name: telegram_alert
  Type: post
  APIEndpoint: https://api.telegram.org/bot<TOKEN>/sendMessage
  APIPayload:
    chat_id: "your_chat_id"
    text: "Liquidation protection activated! Collateral added successfully."
```

**Example: Update dashboard**

```yaml
- Name: update_dashboard
  Type: post
  APIEndpoint: https://your-dashboard.com/api/positions/update
  APIPayload:
    position_id: "aave_eth_main"
    status: "protected"
    last_action: "collateral_topup"
```

## Step 8: Compile and validate

Before deploying, validate your workflow configuration:

1. Select **Compile** in the YAML editor
2. Review the compilation output for any syntax errors
3. Verify all contract addresses are correct for your target chain
4. Confirm transfer amounts are in the correct decimal format

<Tip>
  Test with small amounts first. Deploy a test workflow with minimal transfer values to verify the logic before protecting high-value positions.
</Tip>

## Step 9: Deploy and activate

Once validated, deploy your liquidation protection workflow:

1. Select **Save Workflow**
2. Approve the transaction in your wallet
3. Select **Deploy** to submit to the Kwala network
4. Select **Activate** to start monitoring

<Warning>
  Ensure your workflow wallet has sufficient funds for both gas fees and the collateral transfers it will execute. Running out of funds defeats the protection purpose.
</Warning>

## Complete workflow example

Here's the full YAML configuration for the liquidation protection workflow:

```yaml
Name: Liquidation_Protection_Aave_ETH
Trigger:
  TriggerSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  TriggerChainID: 1
  TriggerEventName: Transfer(address,address,uint256)
  TriggerEventFilter: NA
  TriggerSourceContractABI: W3siaw5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAiLCJuYW1lIjoiX3lmdiIsInR5cGUiOiJhZGRyZXNzIn0seyJpbnRlcm5...
  TriggerPrice: NA
  RecurringSourceContract: 0x49e833337ece7afe375e44f4e3e8481029218e5c
  RecurringChainID: 1
  RecurringEventName: Transfer(address,address,uint256)
  RecurringEventFilter: NA
  RecurringSourceContractABI: W3siaw5wdXRzIjpbeyJpbnRlcm5hbFR5cGUiOiJjb250cmFjdCBJRVJDMjAiLCJuYW1lIjoiX3lmdiIsInR5cGUiOiJhZGRyZXNzIn0seyJpbnRlcm5...
  RecurringPrice: NA
  RepeatEvery: event
  ExecuteAfter: event
  ExpiresIn: 1781796603
  Meta: NA
  ActionStatusNotificationPOSTURL: https://workflow-notification-test.kalp.network/push_notification
  ActionStatusNotificationAPIKey: NA
Actions:
  - Name: transfer_funds
    Type: call
    APIEndpoint: NA
    APIPayload:
      Message: NA
    TargetContract: 0x0f51bb10119727a7e5ea3538074fb341f56b09ad
    TargetFunction: function transfer(address recipient,uint256 amount)
    TargetParams:
      - 0x49e833337ece7afe375e44f4e3e8481029218e5c
      - 100
    ChainID: 1
    EncodedABI: NA
    Bytecode: NA
    Metadata: NA
    RetriesUntilSuccess: 5
  - Name: notification_action
    Type: post
    APIEndpoint: https://workflow-notification-test.kalp.network/push_notification
    APIPayload:
      recharged: true
    TargetContract: NA
    TargetFunction: NA
    TargetParams: NA
    ChainID: NA
    EncodedABI: NA
    Bytecode: NA
    Metadata: NA
    RetriesUntilSuccess: 5
Execution:
  Mode: sequential
```

## How it works

The workflow uses a **recurring event-based trigger** that continuously monitors a token contract for Transfer events. When the specified event occurs, the workflow executes **sequential actions**: first transferring collateral funds to protect your position, then sending a notification to confirm the protective action was taken. The sequential execution ensures the transfer completes successfully before any notifications are sent.

## Next steps

<CardGroup cols={2}>
  <Card title="Monitor workflow" icon="chart-line" href="/workflow-builder/monitor-workflow">
    Track your workflow execution status
  </Card>
  <Card title="Best practices" icon="lightbulb" href="/concepts/best-practices">
    Optimize your workflow configuration
  </Card>
</CardGroup>
